#!/bin/bash

IDX=1
RECONFIG_RM=
RECONFIG_CAT=
RECONFIG_RESET=
RECONFIG_EDIT=
BUILD=
while [ $IDX -le $# ]; do
    case ${!IDX} in
        -rm)
            RECONFIG_RM=1
            shift
            ;;
        -cat)
            RECONFIG_CAT=1
            shift
            ;;
        -reset)
            RECONFIG_RESET=1
            shift
            ;;
        -editor|-edit)
            RECONFIG_EDIT=1
            shift
            ;;
        -build=*)
            BUILD=`echo ${!IDX} | sed -e 's,^-build=,,'`
            shift
            ;;
        -b|-build)
            shift
            BUILD=${!IDX}
            shift
            ;;
        *)
            ;;
    esac
    IDX=$((IDX+1))
done

if [ "$RESET" -a "$EDIT" ] || [ "$RESET" -a "$CAT" ]; then
    echo "Invalid combination of arguments." >2
    return 1
fi

if [ -z "$BUILD" ]; then
    if [ -d "$1" ]; then
        BUILD="$1"
        shift
    elif [ -e "config.status" ]; then
        BUILD="$PWD"
    elif [ -z "$BUILD" ] || [ ! -e "$BUILD/config.status" ]; then
        BUILD=`lsdev.pl build $BUILD -r`
    fi
fi
CONFIGURE=
cd "$BUILD"
echo "Root: $BUILD"
if [ "$RECONFIG_RESET" ]; then
    SRC=`lsdev.pl src - -r`
    if [ -e "$SRC/configure" ]; then
        CONFIGURE="$SRC/configure"
    fi
elif [ -e "config.status" ]; then
    CONFIGURE="./config.status"
    if [ "$RECONFIG_EDIT" ]; then
        test -z "$EDITOR" && EDITOR=vim
        cp ./config.status /tmp/config.status
        if $EDITOR /tmp/config.status && ! diff -q ./config.status /tmp/config.status >/dev/null 2>&1 && [ `wc -c /tmp/config.status | awk '{ print $1 }'` -ge 1 ]; then
            cp /tmp/config.status ./config.status
        else
            CONFIGURE=
        fi
    fi
    if [ "$RECONFIG_CAT" ]; then
        CONFIGURE=
        if [ -e "`which source-highlight`" ]; then
            source-highlight -i config.status -f esc --style-file=esc.style
        else
            cat "config.status"
        fi
    else
        cat "config.status" | yank -c >/dev/null 2>&1
    fi
fi
if [ -n "$CONFIGURE" ]; then
    if [ -e "config.status" ] && [ ! -e "configure" ]; then
        if [ "$RECONFIG_RM" ]; then
            /bin/echo -n "Sure you want to rm -rf in $BUILD? "
            read REALLY
            if [ "$REALLY" = "y" ]; then
                rm -f "/tmp/config.status"
                cp "config.status" "/tmp/config.status"
                rm -rf *
                cp "/tmp/config.status" "config.status"
            fi
        fi
    fi
    "$CONFIGURE" "$@"
fi
