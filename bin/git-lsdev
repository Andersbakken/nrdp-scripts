#!/bin/sh

TEST=
COMMAND=
DEVS=
ERROR=

while [ "$#" -gt 0 ]; do
  OPT="$1"
  shift
  case $OPT in
  -dry) TEST="echo" ;;
  --) COMMAND="$@"; break ;;
  --*) COMMAND=`echo $OPT | sed "s,^--,,g"` ;;
  *)
     if [ -z "$COMMAND" ] && [ "$#" = "0" ]; then
        COMMAND="$OPT"
     else
        DEVS="$DEVS $OPT"
     fi ;;
  esac
done


if [ -z "$COMMAND" ]; then
   echo "No command provided!"
   exit 1
fi

first=
for dir in `lsdev.pl -l -b -tp $DEVS`; do
   if [ -d "$dir" ]; then
       cd "$dir"
       if git rev-parse >/dev/null 2>&1; then
           if [ -n "$first" ]; then
               echo
               echo
           fi
           first=0
           echo "============================================================="
           echo "Processing: $dir ($COMMAND)"
           echo "============================================================="
           $TEST git $COMMAND || ERROR=1
       fi
   fi
done

if [ -n "$ERROR" ]; then
	echo "\n\nThere were errors!!!!!"
	exit 1
fi
