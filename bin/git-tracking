#!/bin/bash
if [ "$#" = 2 ]; then
    branch="$1"
    shift
else
    branch="`git branch | grep '^\*' | cut -d ' ' -f 2`"
fi
echo "$branch" | grep "(" --quiet && exit 1

lookupTracking() {
    remote="`git config \"branch.$branch.remote\"`"
    test -z "$remote" && exit 1
    merge="`git config \"branch.$branch.merge\"`"
    test -z "$merge" && exit 1
    if [ "$remote" = "." ] && echo $merge | grep "^refs/remotes/" --quiet; then
        echo $merge | sed -e 's,^refs/remotes/,,'
    else
        merge="`echo $merge | sed -e 's,^refs\/heads\/,,'`"
        echo "$remote/$merge"
    fi
}

if [ "$#" = 0 ]; then
    lookupTracking
elif [ "$1" = "rebase" ]; then
    tracking=`lookupTracking`
    git rebase --onto "$tracking" "$branch"
else
    if [ "`git --version | sed -e 's,[^0-9],,g' | cut -b1,2`" -lt "18" ]; then
        git branch --set-upstream "$branch" "$1"
    else
        git branch --set-upstream-to="$1" "$branch"
    fi
fi
exit 0
