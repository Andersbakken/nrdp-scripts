#!/bin/bash

sources=()
branches=()

newrepo=
while [ -n "$1" ]; do
    case "$1" in
        --help|-h)
            echo "git merge-repos --repo=/path/to/new/repo --branch=master --branch=14.1 --source=/path/to/repo --source=/tmp/to/repo2"
            exit 0
            ;;
        --repo=*)
            if [ -n "$newrepo" ]; then
                echo "Already specified --repo=$newrepo"
                exit 1
            fi
            newrepo=`echo $1 | sed -e 's,^--repo=,,'`
            ;;
        --branch=*)
            branches+=("`echo $1 | sed -e 's,^--branch=,,'`")
            ;;
        --source=*)
            sources+=("`echo $1 | sed -e 's,^--source=,,'`")
            ;;
        *)
            echo "Unknown command line switch $1"
            exit 1
            ;;
    esac
    shift
done

# if [ "$count" -eq 0 ]; then
#     echo "No source repos specified"
#     exit 1
# fi

if [ -z "$newrepo" ]; then
    echo "No --repo specified"
    exit 1
fi

if [ -e "$newrepo" ]; then
    echo "$newrepo already exists..."
    exit 1
fi

if [ "${#sources[@]}" -eq 0 ]; then
    echo "No sources specified"
    exit 1
fi

if [ "${#branches[@]}" -eq 0 ]; then
    echo "No branches specified"
    exit 1
fi

# echo "$newrepo"
# echo "${sources[@]}"
# echo "${branches[@]}"


mkdir -p "$newrepo"
cd "$newrepo"
git init

idx=0
for source in "${sources[@]}"; do
    sourcename=`basename $source | sed -e 's,\.git,,'`
    # mkdir "$sourcename"
    # cd "$sourcename"
    git remote add $sourcename $source
done
git fetch --all

function moveFile()
{
    test -f "$1" && git mv "$1" "$2"
}

for branch in "${branches[@]}"; do
    git checkout -b $branch
    git commit -m "Initial commit $branch" --allow-empty
    for source in "${sources[@]}"; do
        sourcename=`basename $source | sed -e 's,\.git,,'`
        # git merge -m "Merge branch $branch of $source"  $sourcename/$branch
        git pull --no-edit $sourcename $branch
        moveFile src/CMakeLists.txt src/${sourcename}.cmake
        moveFile CMakeLists.txt ${sourcename}.cmake
        moveFile tests/CMakeLists.txt tests/${sourcename}.cmake
        moveFile tools/CMakeLists.txt tools/${sourcename}.cmake
        moveFile cmake/include.h.in cmake/${sourcename}.include.h.in
        moveFile .gitignore .gitignore.${sourcename}
        git rm .configure.helper
        git rm configure
        moveFile dist_files.txt dist_files.txt.${sourcename}
        moveFile scripts/dist/dist.sh scripts/dist/dist.${sourcename}.sh
        moveFile scripts/dist/dist_buildnumber.sh scripts/dist/dist_buildnumber.${sourcename}.sh
        moveFile scripts/dist/dist_buildnumber.sh scripts/dist/dist_buildnumber.${sourcename}.sh
        moveFile scripts/dist/dist_copy.sh scripts/dist/dist_copy.${sourcename}.sh
        git commit -m "Rename common files $sourcename"
    done
done

cp ./scripts/configure/configure .
git add configure
./scripts/configure/genconfigure.pl

echo "cmake_minimum_required(VERSION 2.8)" > CMakeLists.txt
echo "project(nrdp)" >> CMakeLists.txt
echo "include(nrdapp.cmake)" >> CMakeLists.txt
echo "include(nrdlib.cmake)" >> CMakeLists.txt
echo "include(mdxlib.cmake)" >> CMakeLists.txt





